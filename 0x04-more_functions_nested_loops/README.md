This is the answer to More functions, more nested loops
